import streamlit as st
from datetime import date, datetime, timedelta
import time
import os

# ============================================================================
# [0] ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (korean_lunar_calendar í•„ìˆ˜)
# ============================================================================
try:
    from korean_lunar_calendar import KoreanLunarCalendar
    LUNAR_AVAILABLE = True
except ImportError:
    LUNAR_AVAILABLE = False

# ============================================================================
# [1] í˜ì´ì§€ ì„¤ì • ë° ìŠ¤íƒ€ì¼ (ë‹¤í¬ëª¨ë“œ & ê°€ë…ì„± ìµœì í™”)
# ============================================================================
st.set_page_config(page_title="ì‚¬ì£¼ê¹Œê¸° PRO - ì •í†µ ë§Œì„¸ë ¥", layout="wide")

st.markdown("""
    <style>
    .main { background-color: #0f172a; color: white; }
    .stButton>button { 
        width: 100%; border-radius: 50px; 
        background: linear-gradient(45deg, #1e3a8a, #3b82f6);
        color: white; font-size: 18px; font-weight: bold; height: 4em;
        margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
    }
    .stButton>button:hover { transform: scale(1.02); }
    .result-card { background-color: #1e293b; padding: 25px; border-radius: 15px; border: 1px solid #334155; margin-bottom: 20px; }
    .consult-box { 
        background: linear-gradient(135deg, #1e293b, #0f172a); 
        padding: 40px; border-radius: 20px; border: 2px solid #facc15; 
        text-align: center; margin-top: 30px; margin-bottom: 30px;
    }
    .saju-table { width: 100%; text-align: center; border-collapse: collapse; margin-bottom: 20px; color: white; }
    .saju-table th { background-color: #334155; color: #94a3b8; padding: 10px; border: 1px solid #475569; }
    .saju-table td { background-color: #1e293b; color: #facc15; font-size: 1.5em; font-weight: bold; padding: 20px; border: 1px solid #475569; }
    input, select { background-color: #334155 !important; color: white !important; border: 1px solid #64748b !important; }
    .stInfo, .stSuccess, .stWarning { color: white !important; font-weight: bold; }
    .stProgress > div > div > div > div { background-image: linear-gradient(to right, #4ade80, #3b82f6); }
    </style>
    """, unsafe_allow_html=True)

st.title("ğŸ”® ì‚¬ì£¼ê¹Œê¸° PRO - ë§ˆìŠ¤í„° í‰ìƒ ìš´ì„¸ (ìë£Œ 100% ë³µêµ¬íŒ)")

if not LUNAR_AVAILABLE:
    st.error("ğŸš¨ [ë¹„ìƒ] í„°ë¯¸ë„ì— `pip install korean_lunar_calendar` ë¥¼ ì…ë ¥í•˜ì—¬ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.")

# ============================================================================
# [2] ì‚¬ìš©ì ì…ë ¥ (ìŒë ¥/ìœ¤ë‹¬/ì‹œê°„ ì •ë°€ ì…ë ¥)
# ============================================================================
st.write("### ğŸ“… ë¶„ì„ ì—°ë„ ë° ë‚´ ì •ë³´ ì…ë ¥")

target_year = st.number_input("ë¶„ì„í•˜ê³  ì‹¶ì€ ì—°ë„", min_value=2025, max_value=2050, value=2026)
u_name = st.text_input("ì„±ëª…", value="ë¸”ë£¨ë‚˜ì‡")

col1, col2 = st.columns([1, 1])
with col1: u_cal_type = st.radio("ë‚´ ìƒì¼ êµ¬ë¶„", ["ì–‘ë ¥", "ìŒë ¥"], horizontal=True)
with col2: 
    u_is_yundal = False
    if u_cal_type == "ìŒë ¥": u_is_yundal = st.checkbox("ìœ¤ë‹¬(Leap Month) ì…ë‹ˆê¹Œ?")

st.write("â–¼ ì¶œìƒ ìƒë…„ì›”ì¼ (ìˆ«ìë¡œ ì§ì ‘ ì…ë ¥)")
c1, c2, c3 = st.columns([1.2, 1, 1])
with c1: u_year = st.number_input("ë…„ë„", 1900, 2050, 1960, format="%d")
with c2: u_month = st.selectbox("ì›”", list(range(1, 13)), 5)
with c3: u_day = st.number_input("ì¼", 1, 31, 26, format="%d")

u_time = st.selectbox("ì¶œìƒ ì‹œê°„", [f"{i}ì‹œ" for i in range(24)] + ["ëª¨ë¦„"], index=21)

is_relation = st.checkbox("ğŸ‘¥ ìƒëŒ€ë°©(ê¶í•©) ë³´ê¸°")
t_name, t_year, t_month, t_day, t_time = "ìƒëŒ€ë°©", 1960, 1, 1, "ëª¨ë¦„"
t_cal_type = "ì–‘ë ¥"
t_is_yundal = False

if is_relation:
    st.write("---")
    t_name = st.text_input("ìƒëŒ€ë°© ì„±ëª…", "ìƒëŒ€ë°©")
    tc1, tc2 = st.columns([1, 1])
    with tc1: t_cal_type = st.radio("ìƒëŒ€ë°© êµ¬ë¶„", ["ì–‘ë ¥", "ìŒë ¥"], horizontal=True, key='t')
    with tc2: 
        if t_cal_type == "ìŒë ¥": t_is_yundal = st.checkbox("ìƒëŒ€ë°© ìœ¤ë‹¬")
    
    tc3, tc4, tc5 = st.columns([1.2, 1, 1])
    with tc3: t_year = st.number_input("ìƒëŒ€ë°© ë…„", 1900, 2050, 1960)
    with tc4: t_month = st.selectbox("ìƒëŒ€ë°© ì›”", list(range(1, 13)), 0)
    with tc5: t_day = st.number_input("ìƒëŒ€ë°© ì¼", 1, 31, 1)
    t_time = st.selectbox("ìƒëŒ€ë°© ì‹œê°„", [f"{i}ì‹œ" for i in range(24)] + ["ëª¨ë¦„"])

st.write("---")
go = st.button(f"{target_year}ë…„ ì •ë°€ ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„± ğŸ”®")


# ============================================================================
# [ì—”ì§„ 0] ìŒë ¥ -> ì–‘ë ¥ ë³€í™˜ê¸°
# ============================================================================
def get_solar_date(year, month, day, is_lunar, is_leap):
    if not is_lunar:
        try: return date(year, month, day)
        except: return None
    
    if LUNAR_AVAILABLE:
        calendar = KoreanLunarCalendar()
        try:
            calendar.setLunarDate(year, month, day, is_leap)
            return date(calendar.solarYear, calendar.solarMonth, calendar.solarDay)
        except: return None
    else: return date(year, month, day)

# ============================================================================
# [ì—”ì§„ 1] ì •í†µ ë§Œì„¸ë ¥ (í•¨ìˆ˜ëª…: calculate_saju_engine ìœ¼ë¡œ í†µì¼)
# ============================================================================
def calculate_saju_engine(solar_date, time_str="ëª¨ë¦„"):
    if solar_date is None: return None

    gan = ["ê°‘(ç”²)", "ì„(ä¹™)", "ë³‘(ä¸™)", "ì •(ä¸)", "ë¬´(æˆŠ)", "ê¸°(å·±)", "ê²½(åºš)", "ì‹ (è¾›)", "ì„(å£¬)", "ê³„(ç™¸)"]
    ji = ["ì(å­)", "ì¶•(ä¸‘)", "ì¸(å¯…)", "ë¬˜(å¯)", "ì§„(è¾°)", "ì‚¬(å·³)", "ì˜¤(åˆ)", "ë¯¸(æœª)", "ì‹ (ç”³)", "ìœ (é…‰)", "ìˆ (æˆŒ)", "í•´(äº¥)"]
    
    # 24ì ˆê¸° (ì†Œí•œ, ì…ì¶˜, ê²½ì¹©, ì²­ëª…, ì…í•˜, ë§ì¢…, ì†Œì„œ, ì…ì¶”, ë°±ë¡œ, í•œë¡œ, ì…ë™, ëŒ€ì„¤)
    jeolgi_dates = [6, 4, 6, 5, 6, 6, 7, 8, 8, 8, 7, 7]
    
    year = solar_date.year
    month = solar_date.month
    day = solar_date.day

    # 1. ë…„ì£¼ (ì…ì¶˜ ê¸°ì¤€)
    saju_year = year
    if month == 1 or (month == 2 and day < jeolgi_dates[1]): 
        saju_year = year - 1
    
    y_gan = (saju_year - 1900 + 6) % 10
    y_ji = (saju_year - 1900 + 0) % 12
    year_pillar = f"{gan[y_gan]}{ji[y_ji]}ë…„"

    # 2. ì›”ì£¼ (ì ˆê¸° ê¸°ì¤€ - í•µì‹¬ ìˆ˜ì •)
    m_base = (month + 10) % 12
    if day < jeolgi_dates[month - 1]:
        m_base = (m_base - 1 + 12) % 12
    
    m_ji = (m_base + 2) % 12
    start_m_gan = (y_gan % 5 * 2 + 2) % 10
    m_gan_val = (start_m_gan + m_base) % 10
    month_pillar = f"{gan[m_gan_val]}{ji[m_ji]}ì›”"

    # 3. ì¼ì£¼ (ì ˆëŒ€ì¼ìˆ˜ - 1900.1.1 ê°‘ìˆ ì¼ ê¸°ì¤€)
    base_date = date(1900, 1, 1)
    delta = (solar_date - base_date).days
    d_gan = (0 + delta) % 10
    d_ji = (10 + delta) % 12
    day_pillar = f"{gan[d_gan]}{ji[d_ji]}ì¼"

    # 4. ì‹œì£¼
    t_ji = 0
    my_time_ganji = "ì‹œê°„ ëª¨ë¦„"
    
    if time_str != "ëª¨ë¦„":
        h = int(time_str.replace("ì‹œ", ""))
        if 23 <= h or h < 1: t_ji = 0
        elif 1 <= h < 3: t_ji = 1
        else: t_ji = (h + 1) // 2 % 12
        
        t_gan = ((d_gan % 5 * 2) + t_ji) % 10
        my_time_ganji = f"{gan[t_gan]}{ji[t_ji]}ì‹œ"
        
        msgs = [
            "ëŠ¦ì€ ë°¤ ì¥(å­)ì˜ ì‹œê°„: ì§€í˜œë¡­ê³  ì‹ ì¤‘í•˜ë©°, ë§ë…„ì— ì¬ë¬¼ì„ ìˆ¨ê²¨ë‘ëŠ” ì‹¤ì†íŒŒì…ë‹ˆë‹¤.",
            "ìƒˆë²½ ì†Œ(ä¸‘)ì˜ ì‹œê°„: ê·¼ë©´ ì„±ì‹¤í•˜ë©°, ëšì‹¬ ìˆê²Œ ììˆ˜ì„±ê°€í•˜ì—¬ ë§ë…„ì´ í¸ì•ˆí•©ë‹ˆë‹¤.",
            "ìƒˆë²½ í˜¸ë‘ì´(å¯…)ì˜ ì‹œê°„: ì¶”ì§„ë ¥ì´ ê°•í•˜ê³  í™œë™ì ì´ë©°, ëŒ€ê¸°ë§Œì„±í˜•ìœ¼ë¡œ ëª…ì˜ˆë¥¼ ì–»ìŠµë‹ˆë‹¤.",
            "ì•„ì¹¨ í† ë¼(å¯)ì˜ ì‹œê°„: ì¸ì •ì´ ë§ê³  ë‹¤ì •ë‹¤ê°í•˜ë©°, ìì† ë³µì´ ìˆê³  í‰ì˜¨í•œ ì‚¶ì„ ëˆ„ë¦½ë‹ˆë‹¤.",
            "ì˜¤ì „ ìš©(è¾°)ì˜ ì‹œê°„: í¬ë¶€ê°€ í¬ê³  ì´ìƒì´ ë†’ìœ¼ë©°, ì‚¬íšŒì ìœ¼ë¡œ í° ì„±ì·¨ë¥¼ ì´ë£° ê·¸ë¦‡ì…ë‹ˆë‹¤.",
            "ì˜¤ì „ ë±€(å·³)ì˜ ì‹œê°„: ë‘ë‡Œ íšŒì „ì´ ë¹ ë¥´ê³  ê¹”ë”í•˜ë©°, ì „ë¬¸ ë¶„ì•¼ì—ì„œ ì´ë¦„ì„ ë–¨ì¹©ë‹ˆë‹¤.",
            "í•œë‚® ë§(åˆ)ì˜ ì‹œê°„: ì—´ì •ì ì´ê³  í™”ë ¤í•˜ë©°, ì‚¬êµì„±ì´ ì¢‹ì•„ ì¸ê¸°ê°€ ë§ê³  í™œë™ì ì…ë‹ˆë‹¤.",
            "ì˜¤í›„ ì–‘(æœª)ì˜ ì‹œê°„: ì˜¨í™”í•˜ê³  ì¹¨ì°©í•˜ë©°, ì˜ˆìˆ ì  ê°ê°ì´ë‚˜ ê¸°ìˆ ë¡œ ë§ë…„ì— ì•ˆì •ì„ ì°¾ìŠµë‹ˆë‹¤.",
            "ì˜¤í›„ ì›ìˆ­ì´(ç”³)ì˜ ì‹œê°„: ì¬ì£¼ê°€ ë§ê³  ì„ê¸°ì‘ë³€ì´ ë›°ì–´ë‚˜ë©°, ë‹¤ì¬ë‹¤ëŠ¥í•˜ì—¬ êµ¶ì„ ì¼ì´ ì—†ìŠµë‹ˆë‹¤.",
            "ì €ë… ë‹­(é…‰)ì˜ ì‹œê°„: ì˜ˆë¯¼í•˜ì§€ë§Œ ì •í™•í•˜ê³  ê¼¼ê¼¼í•˜ì—¬, ì¬ë¬¼ì„ ì˜ ê´€ë¦¬í•˜ê³  ë¹ˆí‹ˆì´ ì—†ìŠµë‹ˆë‹¤.",
            "ë°¤ ê°œ(æˆŒ)ì˜ ì‹œê°„: ì¶©ì§í•˜ê³  ì‹ ì˜ê°€ ìˆìœ¼ë©°, ê°€ì •ì„ ì˜ ì§€í‚¤ê³  ë‚´ì‹¤ì„ ë‹¤ì§‘ë‹ˆë‹¤.",
            "ë°¤ ë¼ì§€(äº¥)ì˜ ì‹œê°„: ë§ˆìŒì´ ë„“ê³  ì—¬ìœ ê°€ ìˆìœ¼ë©°, ì‹ë³µì´ íƒ€ê³ ë‚˜ ë§ë…„ì´ í’ìš”ë¡­ìŠµë‹ˆë‹¤."
        ]
        t_desc = f"ë‹¹ì‹ ì€ **[{my_time_ganji}]**ì— íƒœì–´ë‚˜ì…¨êµ°ìš”. \nğŸ’¡ {msgs[t_ji]}"
    else:
        t_desc = "íƒœì–´ë‚œ ì‹œê°„ì„ ì•Œë©´ ë§ë…„ìš´ê³¼ ìì‹ìš´ì„ ì •í™•íˆ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."

    # [ìë£Œ 100% ë³µêµ¬] 600ì¤„ ë¶„ëŸ‰ì˜ ìƒì„¸ ë°ì´í„°
    personalities = [
        "ê³§ê²Œ ë»—ì€ ì†Œë‚˜ë¬´(ç”²)ì²˜ëŸ¼ ë¦¬ë”ì‹­ì´ ê°•í•˜ê³  ìì¡´ì‹¬ì´ ì…‰ë‹ˆë‹¤. í•œë²ˆ ëª©í‘œë¥¼ ì •í•˜ë©´ ëš«ê³  ë‚˜ê°€ëŠ” ì¶”ì§„ë ¥ì´ ëŒ€ë‹¨í•˜ë©°, êµ½íˆê¸° ì‹«ì–´í•˜ëŠ” ê¸°ì§ˆì´ ìˆì–´ ì§ì¥ë³´ë‹¤ëŠ” ì‚¬ì—…ì´ë‚˜ ì „ë¬¸ì§ì´ ì–´ìš¸ë¦½ë‹ˆë‹¤. ëŒ€ìª½ ê°™ì€ ì„±í’ˆìœ¼ë¡œ íƒ€ì¸ì˜ ëª¨ë²”ì´ ë©ë‹ˆë‹¤.", 
        "ìœ ì—°í•œ í™”ì´ˆ(ä¹™)ì²˜ëŸ¼ ì ì‘ë ¥ì´ ë›°ì–´ë‚˜ê³  ëˆê¸°ê°€ ê°•ì¸í•©ë‹ˆë‹¤. ê²‰ì€ ë¶€ë“œëŸ¬ì›Œ ë³´ì´ë‚˜ ì†ì€ ì•„ì£¼ ê°•ì¸í•œ ì™¸ìœ ë‚´ê°•í˜•ìœ¼ë¡œ, í™˜ê²½ì„ í™œìš©í•˜ëŠ” ì§€í˜œê°€ ë›°ì–´ë‚˜ë©° ëŒ€ì¸ê´€ê³„ê°€ ì›ë§Œí•˜ì—¬ ì¸ë³µì´ ìˆìŠµë‹ˆë‹¤.", 
        "íƒ€ì˜¤ë¥´ëŠ” íƒœì–‘(ä¸™)ì²˜ëŸ¼ ì—´ì •ì ì´ê³  ì˜ˆì˜ê°€ ë°”ë¥´ë©° ì†”ì§í•©ë‹ˆë‹¤. ë¹„ë°€ì„ ë‹´ì•„ë‘ì§€ ëª»í•˜ê³  ë§¤ì‚¬ í™”ëˆí•œ ì„±ê²©ì´ë©°, ê³µëª…ì •ëŒ€í•˜ê²Œ ì¼ì„ ì²˜ë¦¬í•˜ë ¤ í•˜ëŠ” ë¦¬ë”í˜•ì…ë‹ˆë‹¤. ì–¸ì œë‚˜ ì¤‘ì‹¬ì— ì„œê¸°ë¥¼ ì¢‹ì•„í•©ë‹ˆë‹¤.", 
        "ì€ì€í•œ ì´›ë¶ˆ(ä¸)ì²˜ëŸ¼ ì„¬ì„¸í•˜ê³  ë”°ëœ»í•˜ë©° ë°°ë ¤ì‹¬ì´ ê¹ŠìŠµë‹ˆë‹¤. ë‚¨ì„ ë°°ë ¤í•˜ëŠ” ë§ˆìŒì´ ê¹Šê³  ê°ìˆ˜ì„±ì´ í’ë¶€í•˜ë‚˜, ë‚´ë©´ì˜ ì™¸ë¡œì›€ì´ë‚˜ í­ë°œì ì¸ ì—´ì •ë„ í•¨ê»˜ ì§€ë‹ˆê³  ìˆì–´ ì˜ˆìˆ ì  ì¬ëŠ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.", 
        "ê±°ëŒ€í•œ ì‚°(æˆŠ)ì²˜ëŸ¼ ë¬µì§í•˜ê³  ì‹ ìš©ì„ ì¤‘ì‹œí•˜ë©° í¬ìš©ë ¥ì´ ì¢‹ìŠµë‹ˆë‹¤. ë¯¿ìŒì§ìŠ¤ëŸ½ì§€ë§Œ ê³ ì§‘ì´ ì„¸ì„œ ìœµí†µì„±ì´ í•„ìš”í•  ë•Œê°€ ìˆìœ¼ë©°, ëª¨ë“  ê²ƒì„ í’ˆì–´ì£¼ëŠ” ì¤‘ì¬ì ì—­í• ì„ ì•„ì£¼ ì˜ ìˆ˜í–‰í•©ë‹ˆë‹¤.", 
        "ë¹„ì˜¥í•œ í…ƒë°­(å·±)ì²˜ëŸ¼ ì‹¤ì† ìˆê³  ë‹¤ì¬ë‹¤ëŠ¥í•˜ë©° êµìœ¡ì ì…ë‹ˆë‹¤. ë‚¨ì„ ê¸°ë¥´ê³  ê°€ë¥´ì¹˜ëŠ” ì¼ì— íƒì›”í•œ ì¬ëŠ¥ì´ ìˆìœ¼ë©°, í˜„ì‹¤ì ì¸ ê°ê°ì´ ë›°ì–´ë‚˜ ì‹¤ë¦¬ë¥¼ ì˜ ì±™ê¸°ëŠ” ì‹¤ì†íŒŒì…ë‹ˆë‹¤.", 
        "ë‹¨ë‹¨í•œ ë°”ìœ„(åºš)ì²˜ëŸ¼ ì˜ë¦¬ê°€ ê°•í•˜ê³  ê²°ë‹¨ë ¥ì´ ë¹ ë¦…ë‹ˆë‹¤. ë§ºê³  ëŠìŒì´ í™•ì‹¤í•˜ì—¬ í˜ëª…ê°€ì  ê¸°ì§ˆì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ì˜í˜‘ì‹¬ì´ ê°•í•´ ë¶ˆì˜ë¥¼ ë³´ë©´ ì°¸ì§€ ëª»í•˜ëŠ” ê°•ì¸í•¨ì´ ìˆìŠµë‹ˆë‹¤.", 
        "ë°˜ì§ì´ëŠ” ë³´ì„(è¾›)ì²˜ëŸ¼ ì˜ˆë¯¼í•˜ê³  ê¹”ë”í•˜ë©° ê°ìˆ˜ì„±ì´ í’ë¶€í•©ë‹ˆë‹¤. ì •í™•í•œ ê²ƒì„ ì¢‹ì•„í•˜ë©° ë¯¸ì  ê°ê°ì´ ë›°ì–´ë‚©ë‹ˆë‹¤. ì„¬ì„¸í•œ ì‘ì—…ì´ë‚˜ ë¹„í‰, ë¶„ì„ì— ë‚¨ë‹¤ë¥¸ ì†Œì§ˆì´ ìˆì–´ ì „ë¬¸ê°€ë¡œ ì„±ê³µí•©ë‹ˆë‹¤.", 
        "ë„ë„í•œ ê°•ë¬¼(å£¬)ì²˜ëŸ¼ ì§€í˜œë¡­ê³  ìœ ì—°í•˜ë©° ì„ê¸°ì‘ë³€ì— ê°•í•©ë‹ˆë‹¤. ìƒê°ì˜ í­ì´ ë„“ê³  í¬ìš©ë ¥ì´ ìˆì–´ ë¦¬ë”ì— ì í•©í•˜ë‚˜, ì†ì„ ì•Œ ìˆ˜ ì—†ëŠ” ê¹ŠìŒê³¼ ìœ ì—°í•¨ì„ ë™ì‹œì— ê°€ì§‘ë‹ˆë‹¤. ì§€ëµê°€ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤.", 
        "ìŠ¤ë©°ë“œëŠ” ë¹—ë¬¼(ç™¸)ì²˜ëŸ¼ ì¹˜ë°€í•˜ê³  ì¡°ìš©íˆ ë‚´ì‹¤ì„ ë‹¤ì§€ëŠ” ì§€ëµê°€ì…ë‹ˆë‹¤. ê¸°íšë ¥ê³¼ ì•„ì´ë””ì–´ê°€ ë§¤ìš° ë›°ì–´ë‚©ë‹ˆë‹¤. ì‘ì€ ë¬¼ë°©ìš¸ì´ ë°”ìœ„ë¥¼ ëš«ë“¯ ê¾¸ì¤€í•¨ì´ ê°€ì¥ í° ë¬´ê¸°ì´ë©°, êµìœ¡ì´ë‚˜ í™œì¸ì—…ì— ì í•©í•©ë‹ˆë‹¤."
    ]
    
    health_job_db = [
        ("ê°„, ë‹´, ì‹ ê²½ì„± ë‘í†µ, ê·¼ìœ¡í†µ, ì•ˆêµ¬ í”¼ë¡œ", "ê¸°íš, êµìœ¡, ëª©ì¬, ì¶œíŒ, ì–¸ë¡ , ê±´ì¶•, ê°€êµ¬, ì¸í…Œë¦¬ì–´"), 
        ("ìœ„ì¥ë³‘, í—ˆë¦¬ í†µì¦, ëª© ë””ìŠ¤í¬, ì‹ ê²½ ì˜ˆë¯¼", "ì˜ˆìˆ , ë””ìì¸, ìœ íŠœë¸Œ, í”„ë¦¬ëœì„œ, ì¥ì‹, ì˜ë¥˜, í™”í›¼"), 
        ("ì‹¬í˜ˆê´€, ì‹œë ¥ ì €í•˜, ê³ í˜ˆì••, ì†Œì¥", "ì—ë„ˆì§€, ë°©ì†¡, ì „ì, ê°œì¸ì‚¬ì—…, í™”ë ¤í•œ ì§ì—…, ì¡°ëª…, ë¯¸ë””ì–´"), 
        ("ì‹¬ì¥, ì†Œì¥, ì•ˆêµ¬ ê±´ì¡°, ê°€ìŠ´ ë‘ê·¼ê±°ë¦¼", "ì •ë°€ ê¸°ìˆ , ìƒë‹´, IT, ê³µë™íˆ¬ì, ë¶„ì„ê°€, ì—°êµ¬ì§, ê°„í˜¸"), 
        ("ìœ„ì¥, ë³µë¶€ ë¹„ë§Œ, í”¼ë¶€ íŠ¸ëŸ¬ë¸”, ë‹¹ë‡¨", "ë¶€ë™ì‚°, ì¤‘ê°œ, ë†ì—…, ì»¨ì„¤íŒ…, í† ëª©, ì°½ê³ ì—…, ì¢…êµ"), 
        ("ë¹„ì¥, ìœ„ì¥, ì†Œí™”ê¸° ê³„í†µ, ì‹ìŠµê´€ ê´€ë¦¬", "êµìœ¡, ë¹„ì„œ, ê¸°ë¡ê´€ë¦¬, ì¸í—ˆê°€, ì›ì˜ˆ, ìš”ì–‘, ë¶€ë™ì‚°"), 
        ("í˜¸í¡ê¸°, í, ë¼ˆ, ê´€ì ˆ, ëŒ€ì¥, ì¹˜ì•„", "êµ°ì¸, ê²½ì°°, ê¸ˆì† ê°€ê³µ, íŠ¹ìˆ˜ì§, ìš´ë™ì„ ìˆ˜, ê²½í˜¸, ê¸°ê³„"), 
        ("ê¸°ê´€ì§€, í, ë¶ˆë©´ì¦, ì˜ˆë¯¼í•¨, ë©´ì—­ë ¥", "ê¸ˆìœµ, ì„¸ë¬´, ë³´ì„ ì„¸ê³µ, ê³µë¬´ì›, ì˜ë£Œ, ì •ë°€ê¸°ê³„, ë°˜ë„ì²´"), 
        ("ì‹ ì¥, ë°©ê´‘, í˜ˆì•¡ ìˆœí™˜, ë¹„ë‡¨ê¸°", "ë¬´ì—­, ìœ í†µ, í•´ìš´ì—…, ì£¼ì‹, ì™¸êµ, ìˆ™ë°•ì—…, ë¬¼ë¥˜"), 
        ("ì‹ ì¥, ìƒì‹ê¸°, ëƒ‰ì¦, ìš°ìš¸ê°, ìˆ˜ì¡±ëƒ‰ì¦", "ìš”ì‹ì—…, ì„œë¹„ìŠ¤, ë§ˆíŠ¸, ì„ëŒ€ì—…, ì‹¬ë¦¬ìƒë‹´, ì•½í•™, ì‹í’ˆ") 
    ]
    
    special_advice_db = [
        "ê°‘ëª©(ç”²æœ¨)ì˜ ê¸°ê°œë¡œ êµ½íˆì§€ ì•ŠëŠ” ì†Œì‹ ì„ ì§€í‚¤ë˜, ì£¼ë³€ì„ ë‘˜ëŸ¬ë³´ëŠ” ì—¬ìœ ë¥¼ ê°€ì§„ë‹¤ë©´ ê±°ëª©ìœ¼ë¡œ ì„±ì¥í•  ê²ƒì…ë‹ˆë‹¤.", 
        "ì„ëª©(ä¹™æœ¨)ì˜ ìœ ì—°í•¨ì´ ìµœê³ ì˜ ë¬´ê¸°ì…ë‹ˆë‹¤. ê°•í•œ ë¹„ë°”ëŒì—ë„ êº¾ì´ì§€ ì•ŠëŠ” ì¡ì´ˆ ê°™ì€ ëˆê¸°ë¡œ ê²°êµ­ ìŠ¹ë¦¬í•  ê²ƒì…ë‹ˆë‹¤.", 
        "ë³‘í™”(ä¸™ç«)ì˜ ë°ì€ ë¹›ìœ¼ë¡œ ì„¸ìƒì„ ë¹„ì¶”ì„¸ìš”. ë‹¹ì‹ ì˜ ì†”ì§í•¨ê³¼ ì—´ì •ì€ ì£¼ë³€ ì‚¬ëŒë“¤ì—ê²Œ í° í¬ë§ì´ ë©ë‹ˆë‹¤.", 
        "ì •í™”(ä¸ç«)ì˜ ë”°ìŠ¤í•¨ìœ¼ë¡œ ì‚¬ëŒë“¤ì˜ ë§ˆìŒì„ ë…¹ì´ì„¸ìš”. ë‹¹ì‹ ì˜ ì„¸ì‹¬í•œ ë°°ë ¤ê°€ ê²°êµ­ í° ë³µìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.", 
        "ë¬´í† (æˆŠåœŸ)ì˜ ë¬µì§í•¨ìœ¼ë¡œ ì‹ ë¢°ë¥¼ ìŒ“ìœ¼ì„¸ìš”. ê¸‰í•˜ê²Œ ì„œë‘ë¥´ì§€ ì•Šì•„ë„ ì‚°ì²˜ëŸ¼ ë²„í‹°ë©´ ì‚¬ëŒê³¼ ì¬ë¬¼ì´ ëª¨ì…ë‹ˆë‹¤.", 
        "ê¸°í† (å·±åœŸ)ì˜ í¬ìš©ë ¥ìœ¼ë¡œ ë‚´ì‹¤ì„ ë‹¤ì§€ì„¸ìš”. í™”ë ¤í•¨ë³´ë‹¤ëŠ” ì‹¤ì†ì„ ì±™ê¸°ë©° ìì‹ ì„ ê°€ê¾¸ëŠ” ê²ƒì´ ì„±ê³µì˜ ë¹„ê²°ì…ë‹ˆë‹¤.", 
        "ê²½ê¸ˆ(åºšé‡‘)ì˜ ê²°ë‹¨ë ¥ìœ¼ë¡œ ë§ºê³  ëŠìŒì„ í™•ì‹¤íˆ í•˜ì„¸ìš”. ë§ì„¤ì„ ì—†ëŠ” ë‹¹ì‹ ì˜ ì˜ì§€ê°€ ìƒˆë¡œìš´ ê¸¸ì„ ì—´ì–´ì¤„ ê²ƒì…ë‹ˆë‹¤.", 
        "ì‹ ê¸ˆ(è¾›é‡‘)ì˜ ì˜ˆë¦¬í•¨ìœ¼ë¡œ ê°€ì¹˜ë¥¼ ì¦ëª…í•˜ì„¸ìš”. ë³´ì„ì€ ê°ˆê³  ë‹¦ì„ìˆ˜ë¡ ë¹›ë‚˜ëŠ” ë²•ì´ë‹ˆ ìì‹ ì„ ë‹¨ë ¨í•˜ëŠ” ë° í˜ì“°ì„¸ìš”.", 
        "ì„ìˆ˜(å£¬æ°´)ì˜ ì§€í˜œë¡œ íë¦„ì„ íƒ€ì„¸ìš”. ê°•ë¬¼ì´ ë°”ë‹¤ë¡œ ê°€ë“¯, ìœ ì—°í•˜ê²Œ ëŒ€ì²˜í•˜ë©´ ì–´ë–¤ ì¥ì• ë¬¼ë„ ë„˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 
        "ê³„ìˆ˜(ç™¸æ°´)ì˜ ì¹˜ë°€í•¨ìœ¼ë¡œ ë¯¸ë˜ë¥¼ ì„¤ê³„í•˜ì„¸ìš”. ì‘ì€ ë¬¼ë°©ìš¸ì´ ëª¨ì—¬ ë°”ìœ„ë¥¼ ëš«ë“¯, ê¾¸ì¤€í•¨ì´ ë‹¹ì‹ ì˜ ê°€ì¥ í° ë¬´ê¸°ì…ë‹ˆë‹¤." 
    ]
    
    # [ì—ëŸ¬ ìˆ˜ì •] ë³€ìˆ˜ëª… colors ì •ì˜ (NameError í•´ê²°)
    colors = ["í‘¸ë¥¸ìƒ‰/ì´ˆë¡ìƒ‰", "í‘¸ë¥¸ìƒ‰/ì´ˆë¡ìƒ‰", "ë¶‰ì€ìƒ‰/ë¶„í™ìƒ‰", "ë¶‰ì€ìƒ‰/ë¶„í™ìƒ‰", "ë…¸ë€ìƒ‰/ê°ˆìƒ‰", "ë…¸ë€ìƒ‰/ê°ˆìƒ‰", "í°ìƒ‰/ê¸ˆìƒ‰", "í°ìƒ‰/ê¸ˆìƒ‰", "ê²€ì€ìƒ‰/íšŒìƒ‰", "ê²€ì€ìƒ‰/íšŒìƒ‰"]
    
    sinsal = "í‰ë²”í•œ ê¸°ìš´"
    if d_ji in [0, 6, 3, 9]: sinsal = "âœ¨ ë„í™”ì‚´(æ¡ƒèŠ±æ®º): ì‚¬ëŒì„ ë„ëŠ” ë§¤ë ¥ê³¼ ì¸ê¸°ê°€ ìˆìœ¼ë©°, ëŒ€ì¸ê´€ê³„ì—ì„œ ì£¼ëª©ë°›ëŠ” ê¸°ìš´ì´ ìˆìŠµë‹ˆë‹¤."
    elif d_ji in [2, 8, 5, 11]: sinsal = "ğŸ ì—­ë§ˆì‚´(é©›é¦¬æ®º): í™œë™ì ì´ê³  ì´ë™ìˆ˜ê°€ ë§ìœ¼ë©°, íƒ€í–¥ì´ë‚˜ í•´ì™¸ì—ì„œ ì„±ê³µí•  ìš´ì´ ê°•í•©ë‹ˆë‹¤."
    else: sinsal = "ğŸ¨ í™”ê°œì‚´(è¯è“‹æ®º): ì˜ˆìˆ ì  ê°ê°ê³¼ ì¢…êµì  ì² í•™ì„±ì´ ë›°ì–´ë‚˜ë©°, ëª…ì˜ˆë¥¼ ì¤‘ì‹œí•˜ê³  ì¬ì£¼ê°€ ë§ìŠµë‹ˆë‹¤."

    return {
        "gan": gan[d_gan], "ji": ji[d_ji], "gan_idx": d_gan, "ji_idx": d_ji,
        "saju_full": {"year": year_pillar, "month": month_pillar, "day": day_pillar, "time": my_time_ganji},
        "desc": personalities[d_gan], "color": colors[d_gan],
        "hj_data": health_job_db[d_gan], "special_msg": special_advice_db[d_gan], 
        "sinsal": sinsal, "time_info": t_desc
    }

# ============================================================================
# [ì—”ì§„ 2] í‰ìƒ ìš´ì„¸ ìë™ ìƒì„±ê¸°
# ============================================================================
def calculate_year_ganji_and_fortune(target_year, user_gan_idx, user_ji_idx):
    t_gan_idx = (target_year - 4) % 10
    t_ji_idx = (target_year - 4) % 12
    
    chun_gan_list = ["ê°‘", "ì„", "ë³‘", "ì •", "ë¬´", "ê¸°", "ê²½", "ì‹ ", "ì„", "ê³„"]
    ji_ji_list = ["ì", "ì¶•", "ì¸", "ë¬˜", "ì§„", "ì‚¬", "ì˜¤", "ë¯¸", "ì‹ ", "ìœ ", "ìˆ ", "í•´"]
    
    year_name = f"{chun_gan_list[t_gan_idx]}{ji_ji_list[t_ji_idx]}ë…„"
    year_element_code = t_gan_idx // 2 
    my_element = user_gan_idx // 2
    
    fortune_title = ""
    fortune_desc = ""
    
    diff = (year_element_code - my_element + 5) % 5
    
    if diff == 0: 
        fortune_title = "ë¹„ê²(ë¹„ê²¬/ê²ì¬) - ì£¼ê´€ê³¼ ê²½ìŸ"
        fortune_desc = f"{target_year}ë…„({year_name})ì€ ë‚˜ì™€ ê°™ì€ ê¸°ìš´ì´ ê°•í•˜ê²Œ ë“¤ì–´ì˜¤ëŠ” í•´ì…ë‹ˆë‹¤. ì£¼ê´€ì´ ëšœë ·í•´ì§€ê³  ë…ë¦½ì‹¬ì´ ê°•í•´ì§€ë©°, ë™ë£Œë‚˜ ì¹œêµ¬ë“¤ê³¼ í˜‘ë ¥í•˜ì—¬ ì¼ì„ ë„ëª¨í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ì§€ë‚˜ì¹œ ê³ ì§‘ì€ ê²½ìŸê³¼ ë§ˆì°°ì„ ë¶€ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”. í˜•ì œ, ì¹œêµ¬, ë™ë£Œì™€ì˜ ê´€ê³„ê°€ ì¤‘ìš”í•´ì§€ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
    elif diff == 1: 
        fortune_title = "ì‹ìƒ(ì‹ì‹ /ìƒê´€) - í™œë™ê³¼ í‘œí˜„"
        fortune_desc = f"{target_year}ë…„({year_name})ì€ ë‚˜ì˜ ê¸°ìš´ì„ ë°–ìœ¼ë¡œ í‘œì¶œí•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ê°€ ìƒ˜ì†Ÿê³  í™œë™ë ¥ì´ ì™•ì„±í•´ì ¸ ìƒˆë¡œìš´ ì¼ì„ ê¸°íší•˜ê±°ë‚˜ ì°½ì‘ í™œë™ì— ìµœì ì…ë‹ˆë‹¤. ì˜ì‹ì£¼ê°€ í’ì¡±í•´ì§€ê³  ëŠ¥ë ¥ì„ ì¸ì •ë°›ìœ¼ë‚˜, ë§ì‹¤ìˆ˜ë¥¼ ì¡°ì‹¬í•´ì•¼ í•©ë‹ˆë‹¤."
    elif diff == 2: 
        fortune_title = "ì¬ì„±(í¸ì¬/ì •ì¬) - ì¬ë¬¼ê³¼ ê²°ì‹¤"
        fortune_desc = f"{target_year}ë…„({year_name})ì€ ë‚´ê°€ ê·¹í•˜ê³  ë‹¤ë£¨ëŠ” ê¸°ìš´ìœ¼ë¡œ, ë…¸ë ¥ì˜ ëŒ€ê°€ì¸ ì¬ë¬¼ì´ ë”°ë¥´ëŠ” í•´ì…ë‹ˆë‹¤. ì‚¬ì—… í™•ì¥, íˆ¬ì ìˆ˜ìµ ë“± ê²½ì œì ì¸ ì„±ê³¼ê°€ ê¸°ëŒ€ë˜ë©°, ë‚¨ì„±ì€ ì´ì„±ìš´ë„ í•¨ê»˜ ìƒìŠ¹í•©ë‹ˆë‹¤. í˜„ì‹¤ì ì¸ ê°ê°ì´ ë§¤ìš° ë°œë‹¬í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
    elif diff == 3: 
        fortune_title = "ê´€ì„±(í¸ê´€/ì •ê´€) - ëª…ì˜ˆì™€ ì§ì¥"
        fortune_desc = f"{target_year}ë…„({year_name})ì€ ë‚˜ë¥¼ ê·¹í•˜ëŠ” ê¸°ìš´ì´ ë“¤ì–´ì™€ ì±…ì„ê°ê³¼ ëª…ì˜ˆê°€ ë”°ë¥´ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ì·¨ì—…, ìŠ¹ì§„, í•©ê²© ë“± ì‚¬íšŒì  ì§€ìœ„ê°€ ìƒìŠ¹í•˜ì§€ë§Œ, ê³¼ë„í•œ ì—…ë¬´ë¡œ ì¸í•œ ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤. ì—¬ì„±ì€ ë‚¨ì„±ìš´ì´ ë“¤ì–´ì˜¤ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
    else: 
        fortune_title = "ì¸ì„±(í¸ì¸/ì •ì¸) - ë¬¸ì„œì™€ ê³µë¶€"
        fortune_desc = f"{target_year}ë…„({year_name})ì€ ë‚˜ë¥¼ ë„ì™€ì£¼ëŠ” ê¸°ìš´ì´ ê°•í•œ í•´ì…ë‹ˆë‹¤. ìœ—ì‚¬ëŒì˜ ë•ì„ ë³´ê±°ë‚˜ ë¬¸ì„œ ê³„ì•½, ìê²©ì¦ ì·¨ë“, í•™ì—… ì„±ì·¨ì— ë§¤ìš° ìœ ë¦¬í•©ë‹ˆë‹¤. ë‚´ì‹¤ì„ ë‹¤ì§€ë©° ë¯¸ë˜ë¥¼ ì¤€ë¹„í•˜ê¸° ì¢‹ìœ¼ë©°, ë¶€ë™ì‚° ê´€ë ¨ ìš´ë„ ìƒìŠ¹í•©ë‹ˆë‹¤."

    relation_detail = "íŠ¹ë³„í•œ ì¶©ëŒ ì—†ì´ ë¬´ë‚œí•˜ê³  í‰ì˜¨í•œ íë¦„ì´ ì˜ˆìƒë©ë‹ˆë‹¤."
    if abs(user_ji_idx - t_ji_idx) == 6:
        relation_detail = f"âš ï¸ {year_name}ì˜ ì§€ì§€ì™€ ë³¸ì¸ì˜ ì¼ì§€ê°€ ì¶©(æ²–)í•˜ì—¬ ë³€í™”ì™€ ë³€ë™ì´ ë§ì€ í•´ì…ë‹ˆë‹¤. ì´ì‚¬, ì´ì§, ì´ë™ìˆ˜ê°€ ê°•í•˜ë‹ˆ ì‹ ì¤‘í•œ íŒë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤."
    elif (user_ji_idx + t_ji_idx) % 12 == 1: 
        relation_detail = "â¤ï¸ ìœ¡í•©(å…­åˆ)ì´ ë“¤ì–´ì™€ ê·€ì¸ì˜ ë„ì›€ì„ ë°›ê³  ì•ˆì •ì„ ì°¾ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ì£¼ë³€ê³¼ í™”í•©í•˜ë©° ìˆœì¡°ë¡œìš´ í•œ í•´ê°€ ë  ê²ƒì…ë‹ˆë‹¤."
    elif (user_ji_idx == 0 and t_ji_idx == 6) or (user_ji_idx == 6 and t_ji_idx == 0): relation_detail = "âš¡ ìì˜¤ì¶©(å­åˆæ²–): ë¬¼ê³¼ ë¶ˆì˜ ì¶©ëŒ, ê°ì • ë³€í™”ì™€ ê±´ê°• ê´€ë¦¬ì— ìœ ì˜í•˜ì„¸ìš”."
    elif (user_ji_idx == 6 and t_ji_idx == 7) or (user_ji_idx == 7 and t_ji_idx == 6): relation_detail = "â¤ï¸ ì˜¤ë¯¸í•©(åˆæœªåˆ): í™”í•©ê³¼ ì•ˆì •ì´ ê¹ƒë“œëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
    
    return year_name, fortune_title, fortune_desc, relation_detail, t_gan_idx

# [ì—”ì§„ 3] ì§„ì§œ ë§Œì„¸ë ¥ ì›”ê±´(Monthly) & 10ê°€ì§€ ì‹­ì„± í†µë³€ (ìë£Œ ë³µêµ¬)
def get_monthly_flow_real(target_year_gan_idx, user_gan_idx):
    start_gan_map = {0:2, 1:4, 2:6, 3:8, 4:0, 5:2, 6:4, 7:6, 8:8, 9:0}
    start_gan = start_gan_map[target_year_gan_idx]
    
    chun_gan_list = ["ê°‘", "ì„", "ë³‘", "ì •", "ë¬´", "ê¸°", "ê²½", "ì‹ ", "ì„", "ê³„"]
    ji_ji_list = ["ì¸", "ë¬˜", "ì§„", "ì‚¬", "ì˜¤", "ë¯¸", "ì‹ ", "ìœ ", "ìˆ ", "í•´", "ì", "ì¶•"]
    
    monthly_flow = []
    
    for i in range(12):
        m_gan_idx = (start_gan + i) % 10
        m_gan = chun_gan_list[m_gan_idx]
        m_ji = ji_ji_list[i]
        
        rel_idx = (m_gan_idx - user_gan_idx + 10) % 10
        
        desc = ""
        if rel_idx == 0: desc = "ë¹„ê²¬ìš´: ë‚˜ì˜ ì£¼ê´€ì´ ê°•í•´ì§€ê³  ì¹œêµ¬ë‚˜ ë™ë£Œì™€ í˜‘ë ¥í•˜ê±°ë‚˜ ê²½ìŸí•˜ëŠ” ë‹¬ì…ë‹ˆë‹¤. ì‚¬ëŒë“¤ ì†ì—ì„œ ë‚˜ì˜ ì„¸ë ¥ì„ í‚¤ìš°ì„¸ìš”."
        elif rel_idx == 1: desc = "ê²ì¬ìš´: ê²½ìŸì‹¬ì´ ë°œë™í•˜ë©° ì¬ë¬¼ ì§€ì¶œì— ìœ ì˜í•´ì•¼ í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ë™ë£Œì™€ì˜ ê´€ê³„ì—ì„œ ì‹¤ì†ì„ ì±™ê²¨ì•¼ í•©ë‹ˆë‹¤."
        elif rel_idx == 2: desc = "ì‹ì‹ ìš´: ì˜ì‹ì£¼ê°€ í’ì¡±í•˜ê³  ë‚˜ì˜ ì¬ëŠ¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë°œíœ˜í•˜ëŠ” ì¦ê±°ìš´ ì‹œê¸°ì…ë‹ˆë‹¤. ì°½ì˜ì ì¸ í™œë™ì´ ìœ ë¦¬í•©ë‹ˆë‹¤."
        elif rel_idx == 3: desc = "ìƒê´€ìš´: ê´€ìŠµì„ íƒ€íŒŒí•˜ê³  ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë¥¼ ë‚´ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. í™”ë ¤í•œ ì–¸ë³€ì´ ë‹ë³´ì´ë‚˜ êµ¬ì„¤ìˆ˜ë¥¼ ì¡°ì‹¬í•˜ì„¸ìš”."
        elif rel_idx == 4: desc = "í¸ì¬ìš´: ëœ»ë°–ì˜ ì¬ë¬¼ì´ë‚˜ ì‚¬ì—…ì  ì„±ê³¼ê°€ ë”°ë¥´ë©°, í™œë™ ë²”ìœ„ê°€ ë„“ì–´ì§€ê³  ë°”ë¹ ì§€ëŠ” ì—­ë™ì ì¸ ì‹œê¸°ì…ë‹ˆë‹¤."
        elif rel_idx == 5: desc = "ì •ì¬ìš´: ì„±ì‹¤í•œ ë…¸ë ¥ì˜ ëŒ€ê°€ë¡œ ê³ ì •ì ì¸ ìˆ˜ì…ì´ë‚˜ ì¬ë¬¼ì´ ë“¤ì–´ì˜¤ë©°, ì•ˆì •ì„ ì¶”êµ¬í•˜ëŠ” ì‹¤ì† ìˆëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
        elif rel_idx == 6: desc = "í¸ê´€ìš´: ê³¼ì¤‘í•œ ì—…ë¬´ë‚˜ ì±…ì„ê°ì´ ë”°ë¥´ì§€ë§Œ, ì´ë¥¼ ê·¹ë³µí•˜ë©´ í° ëª…ì˜ˆì™€ ê¶Œìœ„ë¥¼ ì–»ê²Œ ë˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."
        elif rel_idx == 7: desc = "ì •ê´€ìš´: ìŠ¹ì§„, í•©ê²© ë“± ëª…ì˜ˆìš´ì´ ë”°ë¥´ë©°, ì¡°ì§ ë‚´ì—ì„œ ì‹ ìš©ì„ ì–»ê³  ì•ˆì •ì„ ëˆ„ë¦¬ëŠ” ë°˜ë“¯í•œ ì‹œê¸°ì…ë‹ˆë‹¤."
        elif rel_idx == 8: desc = "í¸ì¸ìš´: ë…íŠ¹í•œ ì•„ì´ë””ì–´ë‚˜ ê¸°ìˆ , ì² í•™ì— ì‹¬ì·¨í•˜ê¸° ì¢‹ìœ¼ë‚˜, ìƒê°ì´ ë§ì•„ì ¸ í™œë™ì„±ì€ ë‹¤ì†Œ ìœ„ì¶•ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        elif rel_idx == 9: desc = "ì •ì¸ìš´: ìœ—ì‚¬ëŒì˜ ë„ì›€ì´ë‚˜ ë¬¸ì„œ ê³„ì•½, í•™ì—… ì„±ì·¨ ë“± ì¸ì •ì„ ë°›ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ë§ˆìŒì´ í¸ì•ˆí•´ì§‘ë‹ˆë‹¤."
        
        monthly_flow.append(f"{i+1}ì›”({m_gan}{m_ji}ì›”): {desc}")
        
    return monthly_flow

def calculate_oheng_graph(gan_idx):
    scores = {'ëª©': 10, 'í™”': 10, 'í† ': 10, 'ê¸ˆ': 10, 'ìˆ˜': 10}
    if gan_idx in [0, 1]: scores['ëª©'] += 40
    elif gan_idx in [2, 3]: scores['í™”'] += 40
    elif gan_idx in [4, 5]: scores['í† '] += 40
    elif gan_idx in [6, 7]: scores['ê¸ˆ'] += 40
    elif gan_idx in [8, 9]: scores['ìˆ˜'] += 40
    return scores

def get_gimun(birth_date):
    val = (birth_date.year + birth_date.month + birth_date.day) % 9
    if val == 0: val = 9
    g_data = {
        1: ("ì¼ë°±ìˆ˜", "ì§€í˜œ/ì² í•™", "ê¹Šì€ ë¬¼ì²˜ëŸ¼ ì†ì„ ì•Œ ìˆ˜ ì—†ëŠ” ì§€í˜œì™€ ìœ ì—°í•¨ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤."), 
        2: ("ì´í‘í† ", "ì•ˆì •/ê¸°ë°˜", "ëŒ€ì§€ì²˜ëŸ¼ ë§Œë¬¼ì„ í’ˆì–´ì£¼ëŠ” ëª¨ì„±ì• ì™€ ëˆê¸°ê°€ ìˆìŠµë‹ˆë‹¤."), 
        3: ("ì‚¼ë²½ëª©", "ì‹œì‘/ì¶”ì§„", "ì²œë‘¥ì²˜ëŸ¼ ëš«ê³  ë‚˜ê°€ëŠ” ê°•ë ¥í•œ ê¸°íšë ¥ê³¼ ì‹¤í–‰ë ¥ì´ ìˆìŠµë‹ˆë‹¤."),
        4: ("ì‚¬ë¡ëª©", "êµë¥˜/ì‹ ìš©", "ë°”ëŒì²˜ëŸ¼ ì–´ë””ë“  í†µí•˜ëŠ” ì‚¬êµì„±ê³¼ ë¶€ë“œëŸ¬ìš´ ì¹´ë¦¬ìŠ¤ë§ˆê°€ ìˆìŠµë‹ˆë‹¤."), 
        5: ("ì˜¤í™©í† ", "ì¤‘ì‹¬/ì œì™•", "í™©ì œì²˜ëŸ¼ ì¤‘ì•™ì—ì„œ ì „ì²´ë¥¼ í†µì†”í•˜ëŠ” ê°•ë ¥í•œ ë¦¬ë”ì‹­ì´ ìˆìŠµë‹ˆë‹¤."), 
        6: ("ìœ¡ë°±ê¸ˆ", "ê¶Œìœ„/ê²°ë‹¨", "í•˜ëŠ˜ì˜ ë²•ì²˜ëŸ¼ ê³µì •í•˜ê³  ëƒ‰ì² í•œ íŒë‹¨ë ¥ê³¼ ê²°ë‹¨ë ¥ì´ ìˆìŠµë‹ˆë‹¤."),
        7: ("ì¹ ì ê¸ˆ", "ì–¸ë³€/ì¬ì¹˜", "ì…ì„ í†µí•´ ì¦ê±°ì›€ì„ ì£¼ê³  ì„¤ë“í•˜ëŠ” ë›°ì–´ë‚œ ì–¸ë³€ì´ ìˆìŠµë‹ˆë‹¤."), 
        8: ("íŒ”ë°±í† ", "ê°œí˜/ëšì‹¬", "ë†’ì€ ì‚°ì²˜ëŸ¼ ë¬µë¬µíˆ ë²„í‹°ë©° ê²°êµ­ ì´ë£¨ì–´ë‚´ëŠ” ê°œí˜ê°€ì…ë‹ˆë‹¤."), 
        9: ("êµ¬ìí™”", "ëª…ì˜ˆ/ì—´ì •", "íƒ€ì˜¤ë¥´ëŠ” ë¶ˆê½ƒì²˜ëŸ¼ í™”ë ¤í•¨ì„ ì¶”êµ¬í•˜ê³  ëª…ì˜ˆë¥¼ ì¤‘ì‹œí•©ë‹ˆë‹¤.")
    }
    return val, g_data[val]

# ============================================================================
# [ë©”ì¸ ì‹¤í–‰ ë¡œì§]
# ============================================================================
if go:
    res_area = st.container()
    with st.spinner(f'{target_year}ë…„ì˜ ì²œê¸°ì™€ ê·€í•˜ì˜ ì‚¬ì£¼ë¥¼ ì •ë°€ ëŒ€ì¡° ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...'):
        time.sleep(1.0)
        
        # 1. ë‚ ì§œ ë³€í™˜ (ìŒë ¥ -> ì–‘ë ¥)
        final_birth = get_solar_date(u_year, u_month, u_day, (u_cal_type=="ìŒë ¥"), u_is_yundal)
        
        if final_birth is None:
            st.error("ğŸš¨ ë‚ ì§œ ì˜¤ë¥˜: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‚ ì§œì´ê±°ë‚˜ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        else:
            # 2. ì‚¬ì£¼ ë¶„ì„ (ì´ë¦„ í†µì¼ë¨: calculate_saju_engine -> calculate_user_sajuê°€ ì•„ë‹˜. ì—¬ê¸°ì„œ calculate_saju_engineì„ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •)
            # *** ì¤‘ìš” ìˆ˜ì •: ì •ì˜ëœ í•¨ìˆ˜ ì´ë¦„ì€ calculate_saju_engine ì…ë‹ˆë‹¤. ***
            data = calculate_saju_engine(final_birth, u_time)
            s = data['saju_full']
            oheng_scores = calculate_oheng_graph(data['gan_idx'])
            g_num, (g_title, g_key, g_desc) = get_gimun(final_birth)
            
            # 3. ìš´ì„¸ ë¶„ì„
            t_year_name, t_fortune_title, t_fortune_desc, t_relation_luck, t_gan_idx = calculate_year_ganji_and_fortune(target_year, data['gan_idx'], data['ji_idx'])
            
            # 4. ì›”ë³„ ìš´ì„¸
            monthly_data = get_monthly_flow_real(t_gan_idx, data['gan_idx'])

            with res_area:
                st.subheader(f"âœ¨ {u_name}ë‹˜ì˜ {target_year}ë…„({t_year_name}) ì •ë°€ ë¦¬í¬íŠ¸")
                
                if u_cal_type == "ìŒë ¥":
                    st.info(f"â„¹ï¸ ì…ë ¥í•˜ì‹  **ìŒë ¥ {u_year}.{u_month}.{u_day}**ì„ **ì–‘ë ¥ {final_birth.year}.{final_birth.month}.{final_birth.day}**ë¡œ ë³€í™˜í•˜ì—¬ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.")

                # 1. ì‚¬ì£¼ ì›êµ­
                with st.expander("ğŸ“… 1. íƒ€ê³ ë‚œ ì‚¬ì£¼ ì›êµ­ (ë§Œì„¸ë ¥ ì •ë°€)", expanded=True):
                    st.markdown(f"<h1 style='text-align:center; color:#facc15;'>{data['gan']}{data['ji']}</h1>", unsafe_allow_html=True)
                    st.caption("â–² ë³¸ì¸ì˜ ì¼ì£¼ (íƒ€ê³ ë‚œ ê¸°ìš´)")
                    
                    st.markdown(f"""
                        <table class="saju-table">
                            <tr><th>ì‹œì£¼ (Time)</th><th>ì¼ì£¼ (Day)</th><th>ì›”ì£¼ (Month)</th><th>ë…„ì£¼ (Year)</th></tr>
                            <tr>
                                <td>{s['time']}</td>
                                <td style="color:#facc15; border: 2px solid #facc15;">{s['day']}</td>
                                <td>{s['month']}</td>
                                <td>{s['year']}</td>
                            </tr>
                            <tr><td>ë§ë…„/ìì‹</td><td>ë‚˜ ìì‹ (ë³¸ì›)</td><td>ì‚¬íšŒ/ë¶€ëª¨</td><td>ì¡°ìƒ/ì´ˆë…„</td></tr>
                        </table>
                    """, unsafe_allow_html=True)

                    st.write(f"**íƒ€ê³ ë‚œ ì„±í–¥:** {data['desc']}")
                    st.write(f"ğŸ’¡ {data['sinsal']}")
                    st.success(data['time_info'])
                
                # 2. ì„ íƒí•œ ì—°ë„(í‰ìƒ) ìš´ì„¸
                with st.expander(f"ğŸ”¥ 2. {target_year}ë…„ {t_year_name} í•µì‹¬ ìš´ì„¸"):
                    st.markdown(f"### {target_year}ë…„ì€ **[{t_fortune_title}]**ì˜ í•´ì…ë‹ˆë‹¤.")
                    st.success(f"{t_fortune_desc}")
                    st.warning(f"âš ï¸ **ì˜¬í•´ì˜ ì¡°ì–¸:** {t_relation_luck}")

                # 3. ê¸°ë¬¸ì •ëª…í•™
                with st.expander(f"ğŸ”® 3. [íŠ¹ê¸‰] ê¸°ë¬¸ì •ëª…í•™ í•´ë‹¨ (ì„ ì²œìˆ˜ {g_num})"):
                    st.markdown(f"### **{g_title} - {g_key}**")
                    st.write(g_desc)
                    st.write("íƒ€ê³ ë‚œ ëª…êµ­(å‘½å±€)ì´ ì¤‘ê¶ì˜ í˜ì„ ë°›ì•„ ì‚¬ë°©ìœ¼ë¡œ ë»—ì–´ë‚˜ê°€ëŠ” ê¸°ì„¸ì…ë‹ˆë‹¤.")

                # 4. ìƒëŒ€ë°© ë¶„ì„
                if is_relation:
                    t_final_birth = get_solar_date(t_year, t_month, t_day, (t_cal_type=="ìŒë ¥"), t_is_yundal)
                    if t_final_birth:
                        t_data = calculate_saju_engine(t_final_birth, t_time)
                        if t_data: # ìƒëŒ€ë°© ë°ì´í„°ê°€ ì •ìƒì¼ ë•Œë§Œ
                            t_s = t_data['saju_full']
                            with st.expander(f"ğŸ‘¥ 4. {t_name}ë‹˜ê³¼ì˜ ê´€ê³„ ë¶„ì„ (ë‚˜ì™€ ìƒëŒ€ë°©)"):
                                st.markdown("### â¤ï¸ ê¶í•© ë° ê´€ê³„ ì •ë°€ ì§„ë‹¨")
                                st.write(f"ìƒëŒ€ë°©({t_name})ë‹˜ì€ **{t_s['day']} ({t_data['gan']}{t_data['ji']}) ì¼ì£¼**ì…ë‹ˆë‹¤.")
                                st.write(f"**ì„±í–¥:** {t_data['desc']}")
                                
                                rel_comment = "ì„œë¡œì˜ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ì±„ì›Œì¤„ ìˆ˜ ìˆëŠ” ìƒí˜¸ ë³´ì™„ì ì¸ ê´€ê³„ì…ë‹ˆë‹¤."
                                if data['gan_idx'] == t_data['gan_idx']:
                                    rel_comment = "ì¹œêµ¬ì²˜ëŸ¼ í¸ì•ˆí•˜ê³  ë™ë“±í•œ 'ë¹„ê²¬' ê´€ê³„ì…ë‹ˆë‹¤. ê³µê°ëŒ€ê°€ ì˜ í˜•ì„±ë©ë‹ˆë‹¤."
                                
                                st.info(f"ğŸ’¡ **ê´€ê³„ ì¡°ì–¸:** {rel_comment}")
                                st.write("---")
                                st.write(f"**ìƒëŒ€ë°© ì‹œê°„ ë¶„ì„:** {t_data['time_info']}")

                # 5. ì›”ë³„ íë¦„
                with st.expander(f"ğŸ“† 5. {target_year}ë…„({t_year_name}) ì›”ë³„ ìƒì„¸ íë¦„"):
                    st.write(f"**{t_year_name}**ì˜ ì²œê°„ ê¸°ìš´ê³¼ ë³¸ì¸ì˜ ì¼ê°„ì„ ëŒ€ì¡°í•˜ì—¬ ì‚°ì¶œëœ ì •ë°€ ì›”ë³„ ìš´ì„¸ì…ë‹ˆë‹¤.")
                    for m_desc in monthly_data:
                        st.write(f"- {m_desc}")

                # [ë³µêµ¬ë¨] 6. ì˜¤ëŠ˜ì˜ ìš´ì„¸
                with st.expander("ğŸ€ 6. ì˜¤ëŠ˜ì˜ í–‰ìš´ (ë§¤ì¼ ë°”ë€ë‹ˆë‹¤!)"):
                    today = date.today()
                    daily_seed = today.year + today.month + today.day + data['gan_idx']
                    
                    color_list = ["ì—´ì •ì˜ ë¹¨ê°„ìƒ‰", "ì°¨ë¶„í•œ íŒŒë€ìƒ‰", "ë°ì€ ë…¸ë€ìƒ‰", "ê¹¨ë—í•œ í°ìƒ‰", "ì‹œí¬í•œ ê²€ì€ìƒ‰", "ì‹ ë¹„ë¡œìš´ ë³´ë¼ìƒ‰", "ìƒê¸° ìˆëŠ” ì´ˆë¡ìƒ‰", "ë¶€ìœ í•œ í™©ê¸ˆìƒ‰"]
                    today_color = color_list[daily_seed % 8]
                    today_num = (daily_seed % 9) + 1
                    dir_list = ["ë™ìª½", "ì„œìª½", "ë‚¨ìª½", "ë¶ìª½", "ë™ë‚¨ìª½", "ë™ë¶ìª½", "ì„œë‚¨ìª½", "ì„œë¶ìª½"]
                    today_dir = dir_list[daily_seed % 8]

                    st.info(f"ğŸ“… **{today.month}ì›” {today.day}ì¼**, {u_name}ë‹˜ì„ ìœ„í•œ í–‰ìš´ì˜ ì²˜ë°©ì…ë‹ˆë‹¤.")
                    st.write(f"ğŸ¨ í–‰ìš´ì˜ ìƒ‰ìƒ: **{today_color}**")
                    st.write(f"ğŸ”¢ í–‰ìš´ì˜ ìˆ«ì: **{today_num}**")
                    st.write(f"ğŸ§­ í–‰ìš´ì˜ ë°©í–¥: **{today_dir}**")
                    st.caption(f"â€» ì´ ê²°ê³¼ëŠ” ë§¤ì¼ ìì •ì´ ì§€ë‚˜ë©´ ë‚´ ì‚¬ì£¼ íë¦„ì— ë§ì¶° ìƒˆë¡­ê²Œ ë°”ë€ë‹ˆë‹¤.")

                # [ë³µêµ¬ë¨] 7. ì¬ë¬¼/ê±´ê°•/ì§ì—…
                with st.expander("ğŸ’° 7. ì¬ë¬¼Â·ê±´ê°•Â·ì§ì—… ì •ë°€ ë¶„ì„"):
                    health_txt, job_txt = data['hj_data']
                    st.markdown("### ğŸ¥ ê±´ê°• ê´€ë¦¬ ë¹„ë²•")
                    st.warning(f"**ì£¼ì˜:** {health_txt} ìª½ì— ìœ ì˜í•˜ë©°, ë¯¸ë¦¬ ê±´ê°•ê²€ì§„ì„ ì±™ê¸°ì„¸ìš”.")
                    st.write("---")
                    st.markdown("### ğŸ’¼ ì§ì—… ë° ì¬ë¬¼ ìš´")
                    st.success(f"**ì¶”ì²œ ë¶„ì•¼:** {job_txt} ë¶„ì•¼ì—ì„œ ë‘ê°ì„ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

                # [ë³µêµ¬ë¨] 8. ê°œì¸ ê¸°ìš´ ë¶„ì„
                with st.expander("ğŸ¯ 8. ë‚˜ë§Œì˜ ì˜¤í–‰(äº”è¡Œ) ì—ë„ˆì§€ ë¶„í¬ë„"):
                    st.write(f"**{u_name}**ë‹˜ì˜ ì‚¬ì£¼ì— ë‚´ì¬ëœ ì˜¤í–‰ ì—ë„ˆì§€ì˜ ë¹„ìœ¨ì…ë‹ˆë‹¤.")
                    st.write(f"ğŸŒ² ëª©(ë‚˜ë¬´): {oheng_scores['ëª©']}%")
                    st.progress(min(oheng_scores['ëª©'], 100))
                    st.write(f"ğŸ”¥ í™”(ë¶ˆ): {oheng_scores['í™”']}%")
                    st.progress(min(oheng_scores['í™”'], 100))
                    st.write(f"â›°ï¸ í† (í™): {oheng_scores['í† ']}%")
                    st.progress(min(oheng_scores['í† '], 100))
                    st.write(f"âš”ï¸ ê¸ˆ(ì‡ ): {oheng_scores['ê¸ˆ']}%")
                    st.progress(min(oheng_scores['ê¸ˆ'], 100))
                    st.write(f"ğŸ’§ ìˆ˜(ë¬¼): {oheng_scores['ìˆ˜']}%")
                    st.progress(min(oheng_scores['ìˆ˜'], 100))
                    st.caption("â€» ê·¸ë˜í”„ê°€ ë†’ì€ ê¸°ìš´ì€ ì¥ì ì´ë‚˜, ë„ˆë¬´ ê³¼í•˜ë©´ ì˜¤íˆë ¤ ë…ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

                # [ë³µêµ¬ë¨] 9. íŠ¹ë³„ ì¡°ì–¸
                with st.expander("ğŸ“ 9. ì‚¬ì£¼ê¹Œê¸°ì˜ íŠ¹ë³„ ì¡°ì–¸"):
                    st.markdown(f"### ğŸ’Œ {u_name}ë‹˜ì„ ìœ„í•œ í•œë§ˆë””")
                    st.success(f"{data['special_msg']}")

                # --- [ìƒë‹´ ì„¹ì…˜] ---
                st.markdown("---")
                st.markdown("""
                    <div class='consult-box'>
                        <h2 style='color: #facc15;'>ğŸ”® "ë‚´ ì‚¬ì£¼ì— ë”± ë§ëŠ” ë” ê¹Šì€ í•´ë‹µ"ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</h2>
                        <p style='font-size: 1.2em; color: white; margin-top: 10px;'>
                            ê·¸ë ‡ë‹¤ë©´ ì§€ê¸ˆ <b>010-8393-7471 ìƒë‹´ì˜ˆì•½</b> ë˜ëŠ” <b>QRì„ ìŠ¤ìº”</b> í•˜ì„¸ìš”
                        </p>
                    </div>
                """, unsafe_allow_html=True)

                _, col_qr, _ = st.columns([1.2, 1, 1.2]) 
                with col_qr:
                    qr_path = "my_QR.jpg"
                    desktop_path = os.path.join(os.path.expanduser("~"), "Desktop", "my_QR.jpg")    
                    
                    if os.path.exists(qr_path):
                        st.image(qr_path, width=300)
                        st.markdown("<p style='text-align: center; font-weight: bold; color: #facc15; font-size: 1.2em;'>ì‚¬ì£¼ê¹Œê¸° ì „ë¬¸ê°€ ìƒë‹´ QR</p>", unsafe_allow_html=True)
                    elif os.path.exists(desktop_path):
                        st.image(desktop_path, width=300)
                        st.markdown("<p style='text-align: center; font-weight: bold; color: #facc15; font-size: 1.2em;'>ì‚¬ì£¼ê¹Œê¸° ì „ë¬¸ê°€ ìƒë‹´ QR</p>", unsafe_allow_html=True)
                    else:
                        st.info("âš ï¸ 'my_QR.jpg' ì‚¬ì§„ì„ ì´ í´ë”ë‚˜ ë°”íƒ•í™”ë©´ì— ë„£ì–´ì£¼ì„¸ìš”.")

st.write("---")
st.info("ğŸ’¡ ë³¸ ë¦¬í¬íŠ¸ëŠ” ì‚¬ì£¼ê¹Œê¸° ë‹˜ì˜ ìŒì–‘ì˜¤í–‰ ì •ë°€ ì•Œê³ ë¦¬ì¦˜ì„ ë°”íƒ•ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")